{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* üåô CSS Variables for Theming */
        :root {
            --body-bg: #f8f9fa; /* light: bg-light */
            --card-bg: #ffffff; /* light: bg-white */
            --text-color: #212529; /* light: text-dark */
            --primary-color: #0d6efd; /* Blue */
            --success-color: #198754; /* Green */
            --secondary-text-color: #6c757d; /* light: text-secondary */
            --border-color: rgba(0, 0, 0, 0.125);
        }

        body.dark-mode {
            --body-bg: #212529; /* dark body bg */
            --card-bg: #2b3035; /* dark card bg */
            --text-color: #f8f9fa; /* light text */
            --primary-color: #0d6efd; 
            --success-color: #198754; /* Green remains, but may need adjustment for better contrast */
            --secondary-text-color: #adb5bd; /* Lighter secondary text */
            --border-color: rgba(255, 255, 255, 0.125);
        }

        /* 1. Base Styles: Apply variables to the entire body */
        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* 2. Heading Styles: Ensure main headings use theme colors */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-color); /* Default to theme text color */
        }
        
        /* Apply primary color explicitly to the main task heading */
        .h4.text-primary, h1.text-primary { color: var(--primary-color) !important; }
        .h4.text-success { color: var(--success-color) !important; }

        /* 3. Link/Anchor Styles: Ensure links are visible and colored correctly */
        a { color: var(--primary-color); }
        .dark-mode a { color: var(--primary-color); }
        
        .text-secondary { color: var(--secondary-text-color) !important; }
        .text-muted {
            color: var(--secondary-text-color) !important; /* Muted text follows the theme */
            opacity: 0.8;
        }

        /* 4. Card and List Item Styles (as before, but cleaned up) */
        .card, .list-group-item {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Collapse/Alert Background in Dark Mode for contrast */
        .dark-mode .alert-info {
            background-color: #343a40; /* Darker background for the info box */
            color: #ced4da;
            border-color: #495057;
        }

        /* Task Card Hover/Status Styles */
        .task-card {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .task-card:hover:not(.completed) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
        }

        .dark-mode .task-card:hover:not(.completed) {
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.08);
        }

        .completed {
            opacity: 0.7; 
            text-decoration: line-through;
            border-left: 5px solid var(--success-color) !important; /* Green */
        }
        .pending {
            border-left: 5px solid var(--primary-color) !important; /* Blue */
        }

        .list-group-item-action:hover {
            background-color: rgba(0, 0, 0, 0.05); /* Slight hover effect */
        }
        .dark-mode .list-group-item-action:hover {
            background-color: rgba(255, 255, 255, 0.05); 
        }
    </style>
</head>
<body>
    <form id="csrf-form" style="display:none;" method="POST">
        {% csrf_token %}
    </form>

    <div class="container mt-5">
        <header class="mb-4 d-flex justify-content-between align-items-center">
            <h1 class="text-primary">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1> 
            <div class="d-flex align-items-center">
                <button id="theme-toggle" class="btn btn-outline-secondary btn-sm me-2" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.27 7.29 7.29 7.29 1.436 0 2.8-.49 3.844-1.3A.77.77 0 0 1 15.823 15h-.498a7.21 7.21 0 0 1-9.4-4.852C5.006 8.529 6 6.55 6 5.5s-.19-2.031-.19-2.031z"/>
                    </svg>
                </button>
                
                {% if request.user.is_staff %}
                    <a href="/admin/" class="btn btn-warning btn-sm me-2">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ê–¥–º–∏–Ω–∫—É</a>
                {% endif %}
                
                <form action="{% url 'logout' %}?next={% url 'login' %}" method="post" class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">–í—ã–π—Ç–∏</button>
                </form>
            </div>
        </header>

        {% with user_default_list_id=request.user.task_lists.first.id|default_if_none:"" %}
        <div id="user-info" class="card shadow-lg p-3 mb-4 rounded-4"
             data-username="{{ request.user.username }}" 
             data-token="{{ request.user.profile.verification_token }}"
             data-chat-id="{{ request.user.profile.telegram_chat_id|default:'' }}"
             data-default-list-id="{{ user_default_list_id }}"
             data-is-admin="{{ request.user.is_staff|yesno:'true,false' }}"> 
            
            <h5 class="card-title text-secondary">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ request.user.username }}</h5>
            <div class="d-flex align-items-center">
                {% if request.user.profile.telegram_chat_id %}
                    <span class="badge text-bg-success me-2">Telegram –ê–∫–∫–∞—É–Ω—Ç –ü—Ä–∏–≤—è–∑–∞–Ω</span>
                {% else %}
                    <span class="badge text-bg-warning me-2">Telegram –ù–µ –ü—Ä–∏–≤—è–∑–∞–Ω</span>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#telegramInstructions" aria-expanded="false" aria-controls="telegramInstructions">
                        –ö–∞–∫ –ø—Ä–∏–≤—è–∑–∞—Ç—å?
                    </button>
                {% endif %}
            </div>
            
            <div class="collapse mt-3" id="telegramInstructions">
                <div class="alert alert-info">
                    <p class="mb-2"><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–≤—è–∑–∫–µ Telegram:</strong></p>
                    <ol class="mb-2">
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram: <strong>@taskmanager_vitaliy_bot</strong></li>
                        <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –∫–æ–º–∞–Ω–¥—É –Ω–∏–∂–µ</li>
                        <li>–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
                    </ol>
                </div>
                <p class="mb-0">üîó –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É:</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="telegramCommand" readonly 
                                 value="/start {{ request.user.profile.verification_token }}">
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('telegramCommand')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="checkTelegramStatus()">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≤—è–∑–∫–∏
                    </button>
                    <small class="text-muted ms-2">–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥</small>
                </div>
            </div>
        </div>
        {% endwith %}

        <div class="card shadow-lg p-3 mb-4 rounded-4">
            <h5 class="card-title text-secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏—á–Ω–æ–≥–æ –±–æ—Ç–∞</h5>
            
            <div id="personal-bot-status">
                {% if request.user.profile.personal_bot_token %}
                    <span class="badge text-bg-success me-2">–õ–∏—á–Ω—ã–π –±–æ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: {{ request.user.profile.personal_bot_username }}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearPersonalBot()">–û—Ç–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞</button>
                {% else %}
                    <span class="badge text-bg-warning me-2">–õ–∏—á–Ω—ã–π –±–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#personalBotSetup" aria-expanded="false" aria-controls="personalBotSetup">
                        –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏—á–Ω–æ–≥–æ –±–æ—Ç–∞
                    </button>
                {% endif %}
            </div>
            
            <div class="collapse mt-3" id="personalBotSetup">
                <div class="alert alert-info">
                    <small>
                        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
                        1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –≤ Telegram<br>
                        2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞<br>
                        3. –í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –Ω–∏–∂–µ<br>
                        4. –í–∞—à –ª–∏—á–Ω—ã–π –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏<br>
                        <strong>–í–∞–∂–Ω–æ:</strong> –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ Telegram –∞–∫–∫–∞—É–Ω—Ç –≤—ã—à–µ!
                    </small>
                </div>
                
                <form id="personal-bot-form">
                    <div class="mb-3">
                        <label for="bot-token" class="form-label">–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</label>
                        <input type="password" class="form-control" id="bot-token" 
                                 placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz" required>
                    </div>
                    <div class="mb-3">
                        <label for="bot-username" class="form-label">Username –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="text" class="form-control" id="bot-username" 
                                 placeholder="@my_personal_bot">
                    </div>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</button>
                </form>
            </div>
        </div>
        
        <div id="tasks-list-container" class="row">
            
            <div class="col-md-6 mb-4">
                <div class="h4 text-primary border-bottom pb-2">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (<span id="pending-count">0</span>)</div>
                <div id="pending-tasks-list" class="list-group">
                    </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="h4 text-success border-bottom pb-2">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (<span id="completed-count">0</span>)</div>
                <div id="completed-tasks-list" class="list-group">
                    </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ... (–í–∞—à JavaScript –∫–æ–¥ —Å –ª–æ–≥–∏–∫–æ–π —Ç–µ–º—ã, WebSocket –∏ API) ...
        
        const userInfo = document.getElementById('user-info');
        const pendingList = document.getElementById('pending-tasks-list');
        const completedList = document.getElementById('completed-tasks-list');
        const pendingCount = document.getElementById('pending-count');
        const completedCount = document.getElementById('completed-count');
        
        const DEFAULT_LIST_ID = userInfo.getAttribute('data-default-list-id');
        const IS_ADMIN = userInfo.getAttribute('data-is-admin') === 'true';
        
        if (!DEFAULT_LIST_ID) {
            console.warn("WARNING: Default task list ID is missing. This is fine if tasks are created via Admin.");
        }

        // --- Theme Toggle Logic (unchanged) ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const body = document.body;

        function updateThemeToggleIcon() {
            if (body.classList.contains('dark-mode')) {
                themeToggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun-fill" viewBox="0 0 16 16">
                        <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.414a.5.5 0 1 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.343 3.343a.5.5 0 0 1 .707 0l1.414 1.414a.5.5 0 0 1-.707.707L4.343 4.05a.5.5 0 0 1 0-.707z"/>
                    </svg>
                `;
            } else {
                themeToggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.27 7.29 7.29 7.29 1.436 0 2.8-.49 3.844-1.3A.77.77 0 0 1 15.823 15h-.498a7.21 7.21 0 0 1-9.4-4.852C5.006 8.529 6 6.55 6 5.5s-.19-2.031-.19-2.031z"/>
                    </svg>
                `;
            }
        }
        
        function setSystemTheme() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.classList.add('dark-mode');
            } else if (savedTheme === 'light') {
                body.classList.remove('dark-mode');
            } else {
                // –ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                setSystemTheme();
            }
            updateThemeToggleIcon();
        }

        function toggleTheme() {
            body.classList.toggle('dark-mode');
            const newTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            updateThemeToggleIcon();
        }
        
        // --- API & Utility Functions (unchanged) ---

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // WebSocket Setup (unchanged)
        const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/tasks/';
        let socket;
        
        function connectWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('WebSocket connected.');
                loadTasks(); 
            };

            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                console.log('Received message (WS):', data);

                if (data.type === 'task_update') {
                    handleTaskUpdate(data.task);
                } else if (data.type === 'task_delete') {
                    handleTaskDelete(data.id);
                }
            };

            socket.onclose = (e) => {
                console.log('WebSocket closed. Attempting to reconnect in 3s...', e.reason);
                setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = (err) => {
                console.error('WebSocket error:', err);
                socket.close();
            };
        }

        // --- Task Rendering Functions (unchanged) ---
        
        function createTaskElement(task) {
            const li = document.createElement('div');
            li.id = `task-${task.id}`;
            const assignedUsername = task.assigned_to ? task.assigned_to.username : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
            
            li.className = `task-card list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 rounded-3 shadow-sm ${task.is_completed ? 'completed' : 'pending'}`;
            li.setAttribute('data-id', task.id);

            const content = document.createElement('div');
            content.className = 'flex-grow-1';
            content.innerHTML = `
                <p class="mb-1 fw-bold">${task.title}</p>
                <small class="text-muted">
                    –°–æ–∑–¥–∞–Ω–æ: ${new Date(task.created_at).toLocaleString()} | –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <strong>${assignedUsername}</strong>
                </small>
            `;
            li.appendChild(content);

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'btn-group btn-group-sm ms-3';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = `btn ${task.is_completed ? 'btn-outline-warning' : 'btn-outline-success'}`;
            toggleBtn.textContent = task.is_completed ? '–û—Ç–º–µ–Ω–∏—Ç—å' : '–ì–æ—Ç–æ–≤–æ'; 
            
            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                toggleTaskCompletion(task.id, task.is_completed);
            };
            
            buttonGroup.appendChild(toggleBtn);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger';
            deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            
            if (!IS_ADMIN) {
                deleteBtn.disabled = true;
                deleteBtn.classList.remove('btn-outline-danger');
                deleteBtn.classList.add('btn-secondary');
            } else {
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    const isConfirmed = prompt('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É? –í–≤–µ–¥–∏—Ç–µ "–¥–∞" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.') === '–¥–∞'; 
                    if(isConfirmed) {
                        deleteTask(task.id);
                    }
                };
            }
            buttonGroup.appendChild(deleteBtn);

            li.appendChild(buttonGroup);
            return li;
        }

        function handleTaskUpdate(task) {
            const existingElement = document.getElementById(`task-${task.id}`);
            const newElement = createTaskElement(task);
            
            if (existingElement) {
                existingElement.remove();
            }

            if (task.is_completed) { 
                completedList.prepend(newElement);
            } else {
                pendingList.prepend(newElement);
            }
            updateCounts();
        }

        function handleTaskDelete(taskId) {
            const element = document.getElementById(`task-${taskId}`);
            if (element) {
                element.remove();
            }
            updateCounts();
        }

        function clearLists() {
            pendingList.innerHTML = '';
            completedList.innerHTML = '';
            updateCounts(0, 0);
        }

        function updateCounts() {
            pendingCount.textContent = pendingList.children.length;
            completedCount.textContent = completedList.children.length;
        }

        // ... (–û—Å—Ç–∞–ª—å–Ω—ã–µ API –∏ Utility —Ñ—É–Ω–∫—Ü–∏–∏ - loadTasks, handleApiResponse, toggleTaskCompletion, deleteTask, copyToClipboard, checkTelegramStatus, loadPersonalBotSettings, savePersonalBot, clearPersonalBot - –Ω–µ –º–µ–Ω—è—é—Ç—Å—è) ...
        
        async function loadTasks() {
            clearLists();
            try {
                const response = await fetch('/api/v1/tasks/');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Error fetching tasks:", response.status, errorText);
                    throw new Error(`Failed to fetch tasks with status: ${response.status}`);
                }
                const tasks = await response.json();

                tasks.forEach(task => {
                    handleTaskUpdate(task);
                });
            } catch (error) {
                console.error("Error loading tasks:", error);
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å. –û—à–∏–±–∫–∞: ${error.message}`); 
            }
        }

        async function handleApiResponse(response, successMessage) {
            if (!response.ok) {
                let errorData = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = await response.text();
                }
                
                console.error(`API Error (${response.status}):`, errorData);
                
                let errorMessage = `–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (${response.status}): `;
                if (typeof errorData === 'object' && errorData !== null) {
                    errorMessage += JSON.stringify(errorData, null, 2);
                } else {
                    errorMessage += errorData.substring(0, 100) + '...';
                }
                
                alert(errorMessage); 
                throw new Error(errorMessage);
            }
            console.log(successMessage);
            loadTasks(); 
        }

        async function toggleTaskCompletion(taskId, isCompleted) {
            const endpoint = isCompleted ? 'uncomplete' : 'complete'; 
            
            try {
                const response = await fetch(`/api/v1/tasks/${taskId}/${endpoint}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'), 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                await handleApiResponse(response, `Task ${taskId} toggled to ${endpoint} successfully.`);
                
            } catch (error) {
                console.error(`Error toggling task ${taskId}:`, error);
            }
        }

        async function deleteTask(taskId) {
            if (!IS_ADMIN) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á.');
                return;
            }

            try {
                const response = await fetch(`/api/v1/tasks/${taskId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'), 
                        'Content-Type': 'application/json'
                    },
                });
                
                if (response.status === 204) {
                    console.log(`Task ${taskId} deleted successfully.`);
                    loadTasks(); 
                    return;
                }

                await handleApiResponse(response, `Task ${taskId} deleted successfully.`);
                
            } catch (error) {
                console.error(`Error deleting task ${taskId}:`, error);
            }
        }

        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            document.execCommand("copy");

            const btn = copyText.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        async function checkTelegramStatus() {
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.telegram_linked) {
                        alert('‚úÖ Telegram —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
                        location.reload();
                    } else {
                        alert('‚ùå Telegram –µ—â–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                }
            } catch (error) {
                console.error('Error checking telegram status:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ Telegram');
            }
        }

        async function loadPersonalBotSettings() {
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Personal bot settings:', data);
                }
            } catch (error) {
                console.error('Error loading bot settings:', error);
            }
        }

        async function savePersonalBot(token, username) {
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        username: username
                    })
                });
                
                if (response.ok) {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving bot settings:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞');
            }
        }

        async function clearPersonalBot() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –ª–∏—á–Ω–æ–≥–æ –±–æ—Ç–∞?')) return;
            
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (response.ok) {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –æ—á–∏—â–µ–Ω—ã!');
                    location.reload();
                }
            } catch (error) {
                console.error('Error clearing bot settings:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            // Theme setup
            themeToggleBtn.addEventListener('click', toggleTheme);
            loadTheme();
            
            const personalBotForm = document.getElementById('personal-bot-form');
            if (personalBotForm) {
                personalBotForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const token = document.getElementById('bot-token').value;
                    const username = document.getElementById('bot-username').value;
                    savePersonalBot(token, username);
                });
            }
            
            loadPersonalBotSettings();

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Telegram –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç—ã
            const telegramInstructions = document.getElementById('telegramInstructions');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º MutationObserver –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è collapse
            if (telegramInstructions) {
                const observer = new MutationObserver((mutationsList, observer) => {
                    if (telegramInstructions.classList.contains('show')) {
                        // –ù–∞—á–∞–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                        const checkInterval = setInterval(() => {
                             if (!telegramInstructions.classList.contains('show')) {
                                 clearInterval(checkInterval); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –µ—Å–ª–∏ –∑–∞–∫—Ä—ã–ª–∏
                            } else {
                                checkTelegramStatus();
                            }
                        }, 10000);
                    }
                });
                observer.observe(telegramInstructions, { attributes: true, attributeFilter: ['class'] });
            }
        });
    </script>
</body>
</html>