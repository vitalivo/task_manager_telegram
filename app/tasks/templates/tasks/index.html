{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .task-card {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .task-card:hover:not(.completed) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
            border-left: 5px solid #198754 !important;
        }
        .pending {
            border-left: 5px solid #0d6efd !important;
        }
    </style>
</head>
<body class="bg-light">
    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 403: –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–ª–∏—á–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞ –≤ cookies –¥–ª—è AJAX-–∑–∞–ø—Ä–æ—Å–æ–≤. -->
    <form id="csrf-form" style="display:none;" method="POST">
        {% csrf_token %}
    </form>

    <div class="container mt-5">
        <header class="mb-4 d-flex justify-content-between align-items-center">
            <h1 class="text-primary">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1>
            <div class="d-flex align-items-center">
                <!-- –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ê–¥–º–∏–Ω–∫—É" (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
                {% if request.user.is_staff %}
                    <a href="/admin/" class="btn btn-warning btn-sm me-2">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ê–¥–º–∏–Ω–∫—É</a>
                {% endif %}
                
                <form action="{% url 'logout' %}?next={% url 'login' %}" method="post" class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">–í—ã–π—Ç–∏</button>
                </form>
            </div>
        </header>

        <!-- User Info and Telegram Linking -->
        {% with user_default_list_id=request.user.task_lists.first.id|default_if_none:"" %}
        <div id="user-info" class="card shadow-sm p-3 mb-4 bg-white"
             data-username="{{ request.user.username }}" 
             data-token="{{ request.user.profile.verification_token }}"
             data-chat-id="{{ request.user.profile.telegram_chat_id|default:'' }}"
             data-default-list-id="{{ user_default_list_id }}"
             data-is-admin="{{ request.user.is_staff|yesno:'true,false' }}"> 
            
            <h5 class="card-title text-secondary">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ request.user.username }}</h5>
            <div class="d-flex align-items-center">
                {% if request.user.profile.telegram_chat_id %}
                    <span class="badge text-bg-success me-2">Telegram –ê–∫–∫–∞—É–Ω—Ç –ü—Ä–∏–≤—è–∑–∞–Ω</span>
                {% else %}
                    <span class="badge text-bg-warning me-2">Telegram –ù–µ –ü—Ä–∏–≤—è–∑–∞–Ω</span>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#telegramInstructions" aria-expanded="false" aria-controls="telegramInstructions">
                        –ö–∞–∫ –ø—Ä–∏–≤—è–∑–∞—Ç—å?
                    </button>
                {% endif %}
            </div>
            
            <div class="collapse mt-3" id="telegramInstructions">
                <div class="alert alert-info">
                    <p class="mb-2"><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–≤—è–∑–∫–µ Telegram:</strong></p>
                    <ol class="mb-2">
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram: <strong>@taskmanager_vitaliy_bot</strong></li>
                        <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –∫–æ–º–∞–Ω–¥—É –Ω–∏–∂–µ</li>
                        <li>–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
                    </ol>
                </div>
                <p class="mb-0">üîó –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É:</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="telegramCommand" readonly 
                           value="/start {{ request.user.profile.verification_token }}">
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('telegramCommand')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="checkTelegramStatus()">
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≤—è–∑–∫–∏
                    </button>
                    <small class="text-muted ms-2">–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥</small>
                </div>
            </div>
        </div>
        {% endwith %}

        <!-- Personal Bot Settings -->
        <div class="card shadow-sm p-3 mb-4 bg-white">
            <h5 class="card-title text-secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏—á–Ω–æ–≥–æ –±–æ—Ç–∞</h5>
            
            <div id="personal-bot-status">
                {% if request.user.profile.personal_bot_token %}
                    <span class="badge text-bg-success me-2">–õ–∏—á–Ω—ã–π –±–æ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: {{ request.user.profile.personal_bot_username }}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearPersonalBot()">–û—Ç–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞</button>
                {% else %}
                    <span class="badge text-bg-warning me-2">–õ–∏—á–Ω—ã–π –±–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#personalBotSetup" aria-expanded="false" aria-controls="personalBotSetup">
                        –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏—á–Ω–æ–≥–æ –±–æ—Ç–∞
                    </button>
                {% endif %}
            </div>
            
            <div class="collapse mt-3" id="personalBotSetup">
                <div class="alert alert-info">
                    <small>
                        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
                        1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather –≤ Telegram<br>
                        2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞<br>
                        3. –í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –Ω–∏–∂–µ<br>
                        4. –í–∞—à –ª–∏—á–Ω—ã–π –±–æ—Ç –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏<br>
                        <strong>–í–∞–∂–Ω–æ:</strong> –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ Telegram –∞–∫–∫–∞—É–Ω—Ç –≤—ã—à–µ!
                    </small>
                </div>
                
                <form id="personal-bot-form">
                    <div class="mb-3">
                        <label for="bot-token" class="form-label">–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</label>
                        <input type="password" class="form-control" id="bot-token" 
                               placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz" required>
                    </div>
                    <div class="mb-3">
                        <label for="bot-username" class="form-label">Username –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="text" class="form-control" id="bot-username" 
                               placeholder="@my_personal_bot">
                    </div>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</button>
                </form>
            </div>
        </div>
        
        <!-- Tasks List Container -->
        <div id="tasks-list-container" class="row">
            
            <div class="col-md-6 mb-4">
                <div class="h4 text-primary border-bottom pb-2">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (<span id="pending-count">0</span>)</div>
                <div id="pending-tasks-list" class="list-group">
                    <!-- Pending tasks will be inserted here by JS -->
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="h4 text-success border-bottom pb-2">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (<span id="completed-count">0</span>)</div>
                <div id="completed-tasks-list" class="list-group">
                    <!-- Completed tasks will be inserted here by JS -->
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const userInfo = document.getElementById('user-info');
        const pendingList = document.getElementById('pending-tasks-list');
        const completedList = document.getElementById('completed-tasks-list');
        const pendingCount = document.getElementById('pending-count');
        const completedCount = document.getElementById('completed-count');
        
        const DEFAULT_LIST_ID = userInfo.getAttribute('data-default-list-id');
        const IS_ADMIN = userInfo.getAttribute('data-is-admin') === 'true';
        
        if (!DEFAULT_LIST_ID) {
            console.warn("WARNING: Default task list ID is missing. This is fine if tasks are created via Admin.");
        }

        // WebSocket Setup
        const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/tasks/';
        let socket;
        
        function connectWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('WebSocket connected.');
                loadTasks(); 
            };

            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                console.log('Received message (WS):', data);

                if (data.type === 'task_update') {
                    handleTaskUpdate(data.task);
                } else if (data.type === 'task_delete') {
                    handleTaskDelete(data.id);
                }
            };

            socket.onclose = (e) => {
                console.log('WebSocket closed. Attempting to reconnect in 3s...', e.reason);
                setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = (err) => {
                console.error('WebSocket error:', err);
                socket.close();
            };
        }

        // --- Task Rendering Functions ---
        
        function createTaskElement(task) {
            const li = document.createElement('div');
            li.id = `task-${task.id}`;
            const assignedUsername = task.assigned_to ? task.assigned_to.username : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
            
            li.className = `task-card list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 rounded-3 shadow-sm ${task.is_completed ? 'completed' : 'pending'}`;
            li.setAttribute('data-id', task.id);

            const content = document.createElement('div');
            content.className = 'flex-grow-1';
            content.innerHTML = `
                <p class="mb-1 fw-bold">${task.title}</p>
                <small class="text-muted">
                    –°–æ–∑–¥–∞–Ω–æ: ${new Date(task.created_at).toLocaleString()} | –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <strong>${assignedUsername}</strong>
                </small>
            `;
            li.appendChild(content);

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'btn-group btn-group-sm ms-3';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = `btn ${task.is_completed ? 'btn-outline-warning' : 'btn-outline-success'}`;
            toggleBtn.textContent = task.is_completed ? '–û—Ç–º–µ–Ω–∏—Ç—å' : '–ì–æ—Ç–æ–≤–æ'; 
            
            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                toggleTaskCompletion(task.id, task.is_completed);
            };
            
            buttonGroup.appendChild(toggleBtn);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger';
            deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            
            if (!IS_ADMIN) {
                deleteBtn.disabled = true;
                deleteBtn.classList.remove('btn-outline-danger');
                deleteBtn.classList.add('btn-secondary');
            } else {
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    const isConfirmed = prompt('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É? –í–≤–µ–¥–∏—Ç–µ "–¥–∞" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.') === '–¥–∞'; 
                    if(isConfirmed) {
                        deleteTask(task.id);
                    }
                };
            }
            buttonGroup.appendChild(deleteBtn);

            li.appendChild(buttonGroup);
            return li;
        }

        function handleTaskUpdate(task) {
            const existingElement = document.getElementById(`task-${task.id}`);
            const newElement = createTaskElement(task);
            
            if (existingElement) {
                existingElement.remove();
            }

            if (task.is_completed) { 
                completedList.prepend(newElement);
            } else {
                pendingList.prepend(newElement);
            }
            updateCounts();
        }

        function handleTaskDelete(taskId) {
            const element = document.getElementById(`task-${taskId}`);
            if (element) {
                element.remove();
            }
            updateCounts();
        }

        function clearLists() {
            pendingList.innerHTML = '';
            completedList.innerHTML = '';
            updateCounts(0, 0);
        }

        function updateCounts() {
            pendingCount.textContent = pendingList.children.length;
            completedCount.textContent = completedList.children.length;
        }

        // --- API & Utility Functions ---

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function loadTasks() {
            clearLists();
            try {
                const response = await fetch('/api/v1/tasks/');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Error fetching tasks:", response.status, errorText);
                    throw new Error(`Failed to fetch tasks with status: ${response.status}`);
                }
                const tasks = await response.json();

                tasks.forEach(task => {
                    handleTaskUpdate(task);
                });
            } catch (error) {
                console.error("Error loading tasks:", error);
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å. –û—à–∏–±–∫–∞: ${error.message}`); 
            }
        }

        async function handleApiResponse(response, successMessage) {
            if (!response.ok) {
                let errorData = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = await response.text();
                }
                
                console.error(`API Error (${response.status}):`, errorData);
                
                let errorMessage = `–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (${response.status}): `;
                if (typeof errorData === 'object' && errorData !== null) {
                    errorMessage += JSON.stringify(errorData, null, 2);
                } else {
                    errorMessage += errorData.substring(0, 100) + '...';
                }
                
                alert(errorMessage); 
                throw new Error(errorMessage);
            }
            console.log(successMessage);
            loadTasks(); 
        }

        async function toggleTaskCompletion(taskId, isCompleted) {
            const endpoint = isCompleted ? 'uncomplete' : 'complete'; 
            
            try {
                const response = await fetch(`/api/v1/tasks/${taskId}/${endpoint}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'), 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                await handleApiResponse(response, `Task ${taskId} toggled to ${endpoint} successfully.`);
                
            } catch (error) {
                console.error(`Error toggling task ${taskId}:`, error);
            }
        }

        async function deleteTask(taskId) {
            if (!IS_ADMIN) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á.');
                return;
            }

            try {
                const response = await fetch(`/api/v1/tasks/${taskId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'), 
                        'Content-Type': 'application/json'
                    },
                });
                
                if (response.status === 204) {
                    console.log(`Task ${taskId} deleted successfully.`);
                    loadTasks(); 
                    return;
                }

                await handleApiResponse(response, `Task ${taskId} deleted successfully.`);
                
            } catch (error) {
                console.error(`Error deleting task ${taskId}:`, error);
            }
        }

        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            document.execCommand("copy");

            const btn = copyText.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        // --- Telegram Status Checking ---
        async function checkTelegramStatus() {
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.telegram_linked) {
                        alert('‚úÖ Telegram —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω! –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
                        location.reload();
                    } else {
                        alert('‚ùå Telegram –µ—â–µ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                }
            } catch (error) {
                console.error('Error checking telegram status:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ Telegram');
            }
        }

        // --- Personal Bot Management ---
        async function loadPersonalBotSettings() {
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Personal bot settings:', data);
                }
            } catch (error) {
                console.error('Error loading bot settings:', error);
            }
        }

        async function savePersonalBot(token, username) {
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        username: username
                    })
                });
                
                if (response.ok) {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving bot settings:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞');
            }
        }

        async function clearPersonalBot() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –ª–∏—á–Ω–æ–≥–æ –±–æ—Ç–∞?')) return;
            
            try {
                const response = await fetch('/api/v1/tasks/personal-bot/', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                });
                
                if (response.ok) {
                    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –æ—á–∏—â–µ–Ω—ã!');
                    location.reload();
                }
            } catch (error) {
                console.error('Error clearing bot settings:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –±–æ—Ç–∞');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            const personalBotForm = document.getElementById('personal-bot-form');
            if (personalBotForm) {
                personalBotForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const token = document.getElementById('bot-token').value;
                    const username = document.getElementById('bot-username').value;
                    savePersonalBot(token, username);
                });
            }
            
            loadPersonalBotSettings();

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Telegram –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç—ã
            const telegramInstructions = document.getElementById('telegramInstructions');
            if (telegramInstructions && telegramInstructions.classList.contains('show')) {
                setInterval(checkTelegramStatus, 10000);
            }
        });
    </script>
</body>
</html>