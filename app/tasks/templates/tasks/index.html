{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .task-card {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .task-card:hover:not(.completed) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
            border-left: 5px solid #198754 !important;
        }
        .pending {
            border-left: 5px solid #0d6efd !important;
        }
    </style>
</head>
<body class="bg-light">
    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 403: –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–ª–∏—á–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞ –≤ cookies –¥–ª—è AJAX-–∑–∞–ø—Ä–æ—Å–æ–≤. -->
    <form id="csrf-form" style="display:none;" method="POST">
        {% csrf_token %}
    </form>

    <div class="container mt-5">
        <header class="mb-4 d-flex justify-content-between align-items-center">
            <h1 class="text-primary">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1>
            <div class="d-flex align-items-center">
                <!-- –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –≤ –ê–¥–º–∏–Ω–∫—É" (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) -->
                {% if request.user.is_staff %}
                    <a href="/admin/" class="btn btn-warning btn-sm me-2">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ê–¥–º–∏–Ω–∫—É</a>
                {% endif %}
                
                <form action="{% url 'logout' %}?next={% url 'login' %}" method="post" class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">–í—ã–π—Ç–∏</button>
                </form>
            </div>
        </header>

        <!-- User Info and Telegram Linking -->
        {% with user_default_list_id=request.user.task_lists.first.id|default_if_none:"" %}
        <div id="user-info" class="card shadow-sm p-3 mb-4 bg-white"
             data-username="{{ request.user.username }}" 
             data-token="{{ request.user.profile.verification_token }}"
             data-chat-id="{{ request.user.profile.telegram_chat_id|default:'' }}"
             data-default-list-id="{{ user_default_list_id }}"
             data-is-admin="{{ request.user.is_staff|yesno:'true,false' }}"> 
            
            <h5 class="card-title text-secondary">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ request.user.username }}</h5>
            <div class="d-flex align-items-center">
                {% if request.user.profile.telegram_chat_id %}
                    <span class="badge text-bg-success me-2">Telegram –ê–∫–∫–∞—É–Ω—Ç –ü—Ä–∏–≤—è–∑–∞–Ω</span>
                {% else %}
                    <span class="badge text-bg-warning me-2">Telegram –ù–µ –ü—Ä–∏–≤—è–∑–∞–Ω</span>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#telegramInstructions" aria-expanded="false" aria-controls="telegramInstructions">
                        –ö–∞–∫ –ø—Ä–∏–≤—è–∑–∞—Ç—å?
                    </button>
                {% endif %}
            </div>
            
            <div class="collapse mt-3" id="telegramInstructions">
                <p class="mb-0">üîó –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É:</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="telegramCommand" readonly 
                           value="/start {{ request.user.profile.verification_token }}">
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('telegramCommand')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>
        {% endwith %}
        
        <!-- Task Creation Form - –£–î–ê–õ–ï–ù–ê –ò–ó –†–ê–ó–ú–ï–¢–ö–ò -->

        <!-- Tasks List Container -->
        <div id="tasks-list-container" class="row">
            
            <div class="col-md-6 mb-4">
                <div class="h4 text-primary border-bottom pb-2">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (<span id="pending-count">0</span>)</div>
                <div id="pending-tasks-list" class="list-group">
                    <!-- Pending tasks will be inserted here by JS -->
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="h4 text-success border-bottom pb-2">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (<span id="completed-count">0</span>)</div>
                <div id="completed-tasks-list" class="list-group">
                    <!-- Completed tasks will be inserted here by JS -->
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const userInfo = document.getElementById('user-info');
        const pendingList = document.getElementById('pending-tasks-list');
        const completedList = document.getElementById('completed-tasks-list');
        const pendingCount = document.getElementById('pending-count');
        const completedCount = document.getElementById('completed-count');
        // const taskCreationForm = document.getElementById('task-creation-form'); // –£–î–ê–õ–ï–ù–û: —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ –≤ DOM
        
        const DEFAULT_LIST_ID = userInfo.getAttribute('data-default-list-id');
        const IS_ADMIN = userInfo.getAttribute('data-is-admin') === 'true';
        
        if (!DEFAULT_LIST_ID) {
            // –û—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –∞–¥–º–∏–Ω–∫—É
            console.warn("WARNING: Default task list ID is missing. This is fine if tasks are created via Admin.");
        }

        // –£–î–ê–õ–ï–ù–û: –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

        // WebSocket Setup
        const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/tasks/';
        let socket;
        
        function connectWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('WebSocket connected.');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                loadTasks(); 
            };

            socket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                console.log('Received message (WS):', data);

                if (data.type === 'task_update') {
                    handleTaskUpdate(data.task);
                } else if (data.type === 'task_delete') {
                    handleTaskDelete(data.id);
                }
            };

            socket.onclose = (e) => {
                console.log('WebSocket closed. Attempting to reconnect in 3s...', e.reason);
                setTimeout(connectWebSocket, 3000); // Reconnect
            };

            socket.onerror = (err) => {
                console.error('WebSocket error:', err);
                socket.close(); // Force close to trigger reconnect
            };
        }

        // --- Task Rendering Functions ---
        
        function createTaskElement(task) {
            const li = document.createElement('div');
            li.id = `task-${task.id}`;
            // –î–æ–±–∞–≤–ª–µ–Ω–æ: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∑–∞–¥–∞—á–∞
            const assignedUsername = task.assigned_to ? task.assigned_to.username : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
            
            li.className = `task-card list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 rounded-3 shadow-sm ${task.is_completed ? 'completed' : 'pending'}`;
            li.setAttribute('data-id', task.id);

            const content = document.createElement('div');
            content.className = 'flex-grow-1';
            content.innerHTML = `
                <p class="mb-1 fw-bold">${task.title}</p>
                <small class="text-muted">
                    –°–æ–∑–¥–∞–Ω–æ: ${new Date(task.created_at).toLocaleString()} | –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <strong>${assignedUsername}</strong>
                </small>
            `;
            li.appendChild(content);

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'btn-group btn-group-sm ms-3';

            // Complete/Undo Button: –î–û–°–¢–£–ü–ï–ù –î–õ–Ø –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
            const toggleBtn = document.createElement('button');
            toggleBtn.className = `btn ${task.is_completed ? 'btn-outline-warning' : 'btn-outline-success'}`;
            toggleBtn.textContent = task.is_completed ? '–û—Ç–º–µ–Ω–∏—Ç—å' : '–ì–æ—Ç–æ–≤–æ'; 
            
            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                toggleTaskCompletion(task.id, task.is_completed);
            };
            
            buttonGroup.appendChild(toggleBtn);
            
            // Delete Button: –î–û–°–¢–£–ü–ï–ù –¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–û–í
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline-danger';
            deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
            
            // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –£–¥–∞–ª–∏—Ç—å: –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
            if (!IS_ADMIN) {
                deleteBtn.disabled = true;
                deleteBtn.classList.remove('btn-outline-danger');
                deleteBtn.classList.add('btn-secondary');
            } else {
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    const isConfirmed = prompt('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É? –í–≤–µ–¥–∏—Ç–µ "–¥–∞" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.') === '–¥–∞'; 
                    if(isConfirmed) {
                        deleteTask(task.id);
                    }
                };
            }
            buttonGroup.appendChild(deleteBtn);

            li.appendChild(buttonGroup);
            return li;
        }

        function handleTaskUpdate(task) {
            const existingElement = document.getElementById(`task-${task.id}`);
            const newElement = createTaskElement(task);
            
            if (existingElement) {
                existingElement.remove();
            }

            if (task.is_completed) { 
                completedList.prepend(newElement);
            } else {
                pendingList.prepend(newElement);
            }
            updateCounts();
        }

        function handleTaskDelete(taskId) {
            const element = document.getElementById(`task-${taskId}`);
            if (element) {
                element.remove();
            }
            updateCounts();
        }

        function clearLists() {
            pendingList.innerHTML = '';
            completedList.innerHTML = '';
            updateCounts(0, 0);
        }

        function updateCounts() {
            pendingCount.textContent = pendingList.children.length;
            completedCount.textContent = completedList.children.length;
        }


        // --- API & Utility Functions ---

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function loadTasks() {
            clearLists();
            try {
                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ: —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –∑–∞–¥–∞—á–∏ (–ø–æ—Å–∫–æ–ª—å–∫—É –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ)
                const response = await fetch('/api/v1/tasks/');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Error fetching tasks:", response.status, errorText);
                    throw new Error(`Failed to fetch tasks with status: ${response.status}`);
                }
                const tasks = await response.json();

                tasks.forEach(task => {
                    handleTaskUpdate(task);
                });
            } catch (error) {
                console.error("Error loading tasks:", error);
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å. –û—à–∏–±–∫–∞: ${error.message}`); 
            }
        }

        async function handleApiResponse(response, successMessage) {
            if (!response.ok) {
                let errorData = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = await response.text();
                }
                
                console.error(`API Error (${response.status}):`, errorData);
                
                let errorMessage = `–û—à–∏–±–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (${response.status}): `;
                if (typeof errorData === 'object' && errorData !== null) {
                    errorMessage += JSON.stringify(errorData, null, 2);
                } else {
                    errorMessage += errorData.substring(0, 100) + '...';
                }
                
                alert(errorMessage); 
                throw new Error(errorMessage);
            }
            console.log(successMessage);
            // FALLBACK: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ WS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            loadTasks(); 
        }

        // –£–î–ê–õ–ï–ù–û: —Ñ—É–Ω–∫—Ü–∏—è createTask()

        async function toggleTaskCompletion(taskId, isCompleted) {
            // –î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            
            const endpoint = isCompleted ? 'uncomplete' : 'complete'; 
            
            try {
                const response = await fetch(`/api/v1/tasks/${taskId}/${endpoint}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'), 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                await handleApiResponse(response, `Task ${taskId} toggled to ${endpoint} successfully.`);
                
            } catch (error) {
                console.error(`Error toggling task ${taskId}:`, error);
            }
        }

        async function deleteTask(taskId) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω (–æ—Å—Ç–∞–ª–∞—Å—å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ö–æ—Ç—è –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞)
            if (!IS_ADMIN) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á.');
                return;
            }

            try {
                const response = await fetch(`/api/v1/tasks/${taskId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'), 
                        'Content-Type': 'application/json'
                    },
                });
                
                // DELETE –æ–±—ã—á–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 204 No Content
                if (response.status === 204) {
                    console.log(`Task ${taskId} deleted successfully.`);
                    // FALLBACK: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    loadTasks(); 
                    return;
                }

                await handleApiResponse(response, `Task ${taskId} deleted successfully.`);
                
            } catch (error) {
                console.error(`Error deleting task ${taskId}:`, error);
            }
        }

        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            document.execCommand("copy");

            const btn = copyText.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        document.addEventListener('DOMContentLoaded', connectWebSocket);
    </script>
</body>
</html>